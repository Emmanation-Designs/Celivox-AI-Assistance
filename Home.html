<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Celivox - AI Assistant</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root{
    --bg-light-start:#f0f7ff; --bg-light-end:#dbeafe;
    --bg-dark-start:#071123; --bg-dark-end:#071a2b;
    --accent:#2563eb; --accent-2:#9333ea;
    --card:#ffffff;
    --muted:#6b7280;
  }
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; transition:background .45s ease,color .3s ease;}
  body{
    display:flex;align-items:center;justify-content:flex-start;flex-direction:column;
    background:linear-gradient(135deg,var(--bg-light-start),var(--bg-light-end));
    color:#07203a;padding:28px;box-sizing:border-box;
  }
  body.dark{
    background:linear-gradient(135deg,var(--bg-dark-start),var(--bg-dark-end));
    color:#dbeafe;
  }

  /* Top bar: hamburger + title */
  .topbar{
    position:fixed; top:12px; left:12px; display:flex; align-items:center; gap:12px; z-index:1200;
  }
  #menuToggle{ width:44px; height:44px; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:4px; padding:8px; border-radius:10px; cursor:pointer; background:transparent; border:none; }
  #menuToggle div{ width:22px; height:3px; background-color:var(--accent); border-radius:3px; transition: transform .25s, opacity .25s; }
  .ai-title{
    font-size:1.05rem; font-weight:800; line-height:1; padding:8px 12px; border-radius:10px;
    background: linear-gradient(90deg,var(--accent),var(--accent-2));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    display:inline-block;
  }

  /* Toggle switch (top right) */
  .toggle-container{ position:fixed; top:12px; right:12px; z-index:1200; }
  .toggle-switch{
    width:66px; height:34px; border-radius:34px; background:#e5e7eb; position:relative; cursor:pointer;
    box-shadow: 0 4px 10px rgba(2,6,23,0.08), inset 0 -3px 8px rgba(0,0,0,0.06);
    transition: background .25s ease;
  }
  .toggle-switch.on{ background:#111827; }
  .toggle-switch::after{
    content:""; width:30px; height:30px; border-radius:50%;
    background:#000; position:absolute; top:2px; left:2px;
    transition: transform .28s cubic-bezier(.2,.9,.3,1), background .28s;
    box-shadow: 0 6px 18px rgba(2,6,23,0.18);
  }
  .toggle-switch.on::after{ transform: translateX(32px); background:#fff; }

  /* Layout container */
  .container{
    width:100%; max-width:920px; margin-top:80px; display:flex; gap:18px; align-items:flex-start;
  }

  /* Left column - robot & chat */
  .panel{
    flex:1; display:flex; flex-direction:column; align-items:center;
  }

  /* Card */
  .card{
    width:100%; background:var(--card); border-radius:14px; box-shadow: 0 8px 30px rgba(2,6,23,0.06);
    padding:18px; box-sizing:border-box;
  }
  body.dark .card{ background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); box-shadow:none; border:1px solid rgba(255,255,255,0.02); }

  /* Robot */
  .robot{
    position: relative; width:260px; max-width:70vw; margin:6px 0 18px 0;
  }
  .robot img{ width:100%; height:auto; display:block; border-radius:12px; }
  /* mouth: kept very small per request */
  .mouth{
    position:absolute; left:50%; top:46%; transform: translate(-50%,-50%);
    width:8%; aspect-ratio:2/1; border-radius:999px;
    background: linear-gradient(180deg,#00c6ff,#0072ff);
    box-shadow: 0 4px 12px rgba(37,99,235,0.18);
    z-index:10; pointer-events:none; transform-origin:center;
  }
  .mouth.talking{ animation: mouth-move 420ms infinite ease-in-out; }
  @keyframes mouth-move {
    0%   { transform: translate(-50%,-50%) scaleY(.55); filter:brightness(.9); }
    50%  { transform: translate(-50%,-50%) scaleY(1.45); filter:brightness(1.05); }
    100% { transform: translate(-50%,-50%) scaleY(.65); filter:brightness(.95); }
  }

  /* Chat area */
  .chatBox{
    width:100%; height:420px; overflow:auto; padding:14px; border-radius:12px;
    background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(255,255,255,0.02));
    display:flex; flex-direction:column; gap:12px;
  }
  body.dark .chatBox{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); }

  .bubble{
    max-width:78%; padding:12px 14px; border-radius:16px; font-size:0.98rem; line-height:1.3;
    box-shadow: 0 6px 18px rgba(2,6,23,0.04);
  }
  .bubble.ai{
    align-self:flex-start; background:linear-gradient(90deg,#eef2ff,#eef7ff); color:#07203a; border-top-left-radius:4px;
  }
  .bubble.user{
    align-self:flex-end; background:linear-gradient(90deg,#2563eb,#1e3a8a); color:#fff; border-top-right-radius:4px;
  }
  body.dark .bubble.ai{ background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); color:#dbeafe; }
  body.dark .bubble.user{ background: linear-gradient(90deg,#1e40af,#0f172a); }

  .meta{ font-size:0.78rem; color:var(--muted); margin-top:6px; display:block; }

  /* controls */
  .controls{ width:100%; display:flex; gap:12px; margin-top:12px; align-items:center; justify-content:center; }
  .talk-btn{
    border:none; padding:12px 20px; border-radius:999px; font-weight:800; font-size:1rem; color:white;
    background:linear-gradient(90deg,#2563eb,#9333ea); cursor:pointer; box-shadow:0 10px 30px rgba(37,99,235,0.18);
    display:flex; gap:10px; align-items:center;
  }
  .talk-btn[disabled]{ opacity:.6; cursor:not-allowed; }

  /* Right column - optional info / small space (we use for nothing now) */
  .right{
    width:260px;
  }

  /* Login/Register box */
  #authSection{ width:420px; max-width:94%; background:var(--card); padding:26px; border-radius:12px; box-shadow:0 8px 30px rgba(2,6,23,0.06); }
  #authSection h2{ margin:0 0 12px 0; }
  #authSection input{ width:100%; padding:12px; margin:8px 0; border-radius:8px; border:1px solid rgba(2,6,23,0.06); box-sizing:border-box; }
  #authSection .password-container{ position:relative; }
  #authSection .password-container i{ position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; color:var(--muted); }

  /* Sidebar menu */
  #sidebarMenu{
    height:100%; width:0; position:fixed; top:0; left:0; background:linear-gradient(180deg,var(--bg-light-start),var(--bg-light-end));
    overflow-x:hidden; transition: width .28s ease, background .28s ease; padding-top:74px; z-index:1300; box-shadow:2px 0 18px rgba(2,6,23,0.08);
  }
  body.dark #sidebarMenu{ background:linear-gradient(180deg,var(--bg-dark-start),var(--bg-dark-end)); }
  #sidebarMenu .item{ display:flex; align-items:center; gap:12px; padding:12px 18px; color:var(--accent); font-weight:700; text-decoration:none; cursor:pointer; border:none; background:none; width:100%; box-sizing:border-box;}
  #sidebarMenu .item:hover{ background: rgba(37,99,235,0.08); color:#fff; }
  #sidebarClose{ position:absolute; top:16px; right:16px; font-size:28px; cursor:pointer; color:var(--accent); }

  /* Voice select styling inside sidebar */
  #sidebarMenu label{ display:block; padding:12px 18px; color:var(--accent); font-weight:700; }
  #voiceSelect{ display:block; width:calc(100% - 36px); margin:6px 18px 18px 18px; padding:8px; border-radius:8px; border:1px solid rgba(2,6,23,0.06); background:transparent; color:inherit; }

  /* small responsiveness */
  @media (max-width:920px){
    .container{ flex-direction:column; align-items:center; }
    .right{ display:none; }
    #authSection{ width:92%; }
    .chatBox{ height:340px; }
  }
</style>
</head>
<body>

  <!-- Top left: menu + Celivox title -->
  <div class="topbar">
    <button id="menuToggle" title="Open menu" aria-label="Open menu" onclick="openMenu()">
      <div></div><div></div><div></div>
    </button>
    <div class="ai-title">CELIVOX</div>
  </div>

  <!-- Theme toggle -->
  <div class="toggle-container">
    <div class="toggle-switch" id="themeToggle" title="Toggle theme"></div>
  </div>

  <!-- Sidebar -->
  <div id="sidebarMenu" aria-hidden="true">
    <span id="sidebarClose" onclick="closeMenu()">&times;</span>

    <a class="item" href="https://wa.me/2348081682884" target="_blank"><i class="fa-brands fa-square-whatsapp"></i><span>WhatsApp Support</span></a>
    <button class="item" onclick="logout()"><i class="fa-solid fa-arrow-right-from-bracket"></i><span>Logout</span></button>
    <button class="item" onclick="confirmClearMemory()"><i class="fa-solid fa-trash"></i><span>Clear Memory</span></button>

    <label for="voiceSelect">Voice</label>
    <select id="voiceSelect" aria-label="Select voice"></select>
    <button class="item" onclick="switchToTextMode()">
  <i class="fa-solid fa-file-lines"></i><span>Text Mode</span>
</button>
  </div>

  <!-- Main content -->
  <div class="container">
    <!-- If user not logged in: show authSection; otherwise show assistantPage -->
    <div id="authSection" class="card" style="display:block;">
      <h2>Register / Login</h2>
      <input id="regUsername" placeholder="Enter Username" />
      <div class="password-container">
        <input id="regPassword" type="password" placeholder="Enter Password" />
        <i id="togglePass" class="fa-solid fa-eye" title="Show/hide password"></i>
      </div>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:8px;">
        <button onclick="register()" style="background:#2563eb;color:#fff;border:none;padding:10px 14px;border-radius:8px;">Register</button>
        <button onclick="login()" style="background:#111827;color:#fff;border:none;padding:10px 14px;border-radius:8px;">Login</button>
      </div>
      <p id="authMessage" style="min-height:18px;margin-top:10px;color:#d33;font-weight:700;"></p>
    </div>

    <!-- Assistant panel -->
    <div class="panel" style="display:none;" id="assistantPanel">
      <div class="card" style="display:flex;flex-direction:column;align-items:center;">
        <div class="robot">
          <img id="robotImage" src="ai.png" alt="Robot" />
          <div class="mouth" id="mouth"></div>
        </div>

        <div class="chatBox" id="chatBox" role="log" aria-live="polite"></div>

        <div class="controls">
          <button class="talk-btn" id="talkBtn" title="Start talking">
            <i class="fa-solid fa-microphone"></i><span id="talkLabel">You Can Talk</span>
          </button>
        </div>

        <div style="width:100%; margin-top:12px; font-size:0.9rem; color:var(--muted); text-align:center;">
          Tip: ask Celivox things or use the side menu to switch to text mode/ clear memory.
        </div>
      </div>
    </div>

    <div class="right"></div>
  </div>
<script>
/* ===========================================
   Full JS: authentication, voice, sidebar,
   TTS, speech recognition, memory, API calls,
   and custom developer/name responses.
   =========================================== */
const devProfile = {
  fullname: "Emmanuel Nwaije Ikemefuna",
  display: "Emmanation",
  created: "September 10th, 2024",
  launched: "September 14th 2024",// or the actual date you want
  tools: "JavaScript, HTML, CSS, and AI technologies",
  purpose: "assist users with AI and coding queries",
  origin: "His is From Ebe on Udi Local Government Area Of Nigeria, Africa",
  bio: "I am a software developer passionate about AI and web technologies."
};
/* ---------- YOUR KEYS ---------- */
const GEMINI_API_KEY = "AIzaSyDlU22AqZ4mCxirbpxAgvxZYDnkNJy3504";
const OPENROUTER_API_KEY = "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";

/* ---------- Elements ---------- */
const authSection = document.getElementById('authSection');
const assistantPanel = document.getElementById('assistantPanel');
const usernameDisplay = document.getElementById('regUsername'); 
const talkBtn = document.getElementById('talkBtn');
const chatBox = document.getElementById('chatBox');
const mouth = document.getElementById('mouth');
const togglePass = document.getElementById('togglePass');
const regPassInput = document.getElementById('regPassword');
const authMessage = document.getElementById('authMessage');
const themeToggle = document.getElementById('themeToggle');
const voiceSelect = document.getElementById('voiceSelect');

/* ---------- Sidebar helpers ---------- */
function openMenu() {
  document.getElementById("sidebarMenu").style.width="300px";
  document.getElementById("sidebarMenu").setAttribute('aria-hidden','false');
}
function closeMenu() {
  document.getElementById("sidebarMenu").style.width="0";
  document.getElementById("sidebarMenu").setAttribute('aria-hidden','true');
}
document.getElementById('sidebarClose').addEventListener('click', closeMenu);

/* ---------- Authentication ---------- */
function showAssistantPage(){
  authSection.style.display = 'none';
  assistantPanel.style.display = 'block';
  
  const name = localStorage.getItem('username') || 'User';
  document.querySelector('.greeting')?.remove();
  const g = document.createElement('div');
  g.className = 'greeting';
  g.style.marginTop = '26px';
  g.innerHTML = `Hey <strong id="usernameDisplay">${name}</strong>, how may I help you?`;
  assistantPanel.querySelector('.card').insertBefore(g, assistantPanel.querySelector('.robot').parentElement);

  loadMemoryIntoChat();
}

function logout(){
  localStorage.setItem('loggedIn','false');
  assistantPanel.style.display = 'none';
  authSection.style.display = 'block';
}

function register(){
  const user = document.getElementById("regUsername").value.trim();
  const pass = document.getElementById("regPassword").value;
  if(!user || !pass){
    authMessage.innerText = "‚ùå Enter username and password!";
    return;
  }
  localStorage.setItem('username', user);
  localStorage.setItem('password', pass);
  localStorage.setItem('loggedIn','true');
  authMessage.innerText = "";
  showAssistantPage();
}

function login(){
  const user = document.getElementById("regUsername").value.trim();
  const pass = document.getElementById("regPassword").value;
  const savedUser = localStorage.getItem('username');
  const savedPass = localStorage.getItem('password');
  if(user === savedUser && pass === savedPass){
    localStorage.setItem('loggedIn','true');
    authMessage.innerText = "";
    showAssistantPage();
  } else {
    authMessage.innerText = "‚ùå Invalid credentials!";
  }
}

/* auto-check login */
window.addEventListener('load', () => {
  if(localStorage.getItem('loggedIn') === 'true'){
    showAssistantPage();
  }
  initTheme();
  loadVoicesWhenReady();
});

/* ---------- Show/Hide password ---------- */
togglePass.addEventListener('click', () => {
  if(regPassInput.type === 'password'){
    regPassInput.type = 'text';
    togglePass.classList.replace('fa-eye','fa-eye-slash');
  } else {
    regPassInput.type = 'password';
    togglePass.classList.replace('fa-eye-slash','fa-eye');
  }
});

/* ---------- Theme ---------- */
function initTheme(){
  const saved = localStorage.getItem('va_theme');
  if(saved === 'dark'){
    document.body.classList.add('dark');
    themeToggle.classList.add('on');
  }
}
themeToggle.addEventListener('click', ()=>{
  const isDark = document.body.classList.toggle('dark');
  themeToggle.classList.toggle('on', isDark);
  localStorage.setItem('va_theme', isDark ? 'dark' : 'light');
});

/* switch to text mode (redirect) */
function switchToTextMode() {
  window.location.href = 'index.html';
}

/* ---------- Persistent memory ---------- */
function saveConversation(q, a){
  const history = JSON.parse(localStorage.getItem('celivox_memory') || '[]');
  history.push({ q, a, time: new Date().toISOString() });
  localStorage.setItem('celivox_memory', JSON.stringify(history));
}

function getConversation(){
  return JSON.parse(localStorage.getItem('celivox_memory') || '[]');
}

function confirmClearMemory(){
  if(confirm("Clear Celivox memory? This will remove saved conversations permanently.")){
    clearMemory();
  }
}

async function clearMemory(){
  const username = localStorage.getItem('username') || 'Guest';
  try{
    const res = await fetch('http://localhost:3000/clearMemory', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username })
    });
    if(!res.ok) throw new Error('Failed to clear memory');
    localStorage.removeItem('celivox_memory'); // optional local cleanup
    chatBox.innerHTML = '';
    alert("‚úÖ Memory cleared!");
  }catch(e){
    console.error(e);
    alert("‚ùå Could not clear memory on server");
  }
}

function loadMemoryIntoChat(){
  const history = getConversation();
  chatBox.innerHTML = '';
  for(const item of history){
    appendBubble('user', item.q, item.time);
    appendBubble('ai', item.a, item.time);
  }
  chatBox.scrollTop = chatBox.scrollHeight;
}

/* ---------- Chat UI ---------- */
function appendBubble(who, text, time){
  const el = document.createElement('div');
  el.className = 'bubble ' + (who === 'user' ? 'user' : 'ai');
  el.textContent = text;

  const meta = document.createElement('span');
  meta.className = 'meta';
  const d = new Date(time || Date.now());
  meta.textContent = d.toLocaleString();
  el.appendChild(meta);

  chatBox.appendChild(el);
  chatBox.scrollTop = chatBox.scrollHeight;

  // ---- SAVE TO MEMORY ----
  if(!time){ // only save new messages, not ones loaded from memory
    if(who === 'user'){
      saveConversation(text, null); // save user message
    } else if(who === 'ai'){
      const history = getConversation();
      if(history.length){
        history[history.length-1].a = text; // pair AI reply with last user message
        localStorage.setItem('celivox_memory', JSON.stringify(history));
      }
    }
  }
}

/* ---------- Voices (TTS) ---------- */
let voices = [];
function loadVoicesWhenReady(){
  voices = speechSynthesis.getVoices();
  if(!voices.length){
    speechSynthesis.onvoiceschanged = () => {
      voices = speechSynthesis.getVoices();
      populateVoiceSelect();
    };
  } else {
    populateVoiceSelect();
  }
}

function populateVoiceSelect(){
  voiceSelect.innerHTML = '';
  const preferredOrder = [
    { label:'Female 1 (natural)', pick: v => /female|zira|sara|emma|amy|alloy/i.test(v.name) },
    { label:'Female 2 (clear)', pick: v => /uk female|english female|en-uk/i.test(v.name) },
    { label:'Male 1 (rich)', pick: v => /male|david|john|matthew/i.test(v.name) },
    { label:'Male 2 (deep)', pick: v => /microsoft david|en-us male|google uk english male/i.test(v.name) }
  ];

  const added = new Set();
  preferredOrder.forEach(pref => {
    const found = voices.find(pref.pick);
    if(found && !added.has(found.name)){
      const opt = document.createElement('option');
      opt.value = found.name;
      opt.textContent = `${pref.label} ‚Äî ${found.name}`;
      voiceSelect.appendChild(opt);
      added.add(found.name);
    }
  });

  voices.forEach(v => {
    if(!added.has(v.name)){
      const opt = document.createElement('option');
      opt.value = v.name;
      opt.textContent = `${v.name} ${v.lang ? '('+v.lang+')':''}`;
      voiceSelect.appendChild(opt);
      added.add(v.name);
    }
  });

  if(!voiceSelect.children.length){
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'Default';
    voiceSelect.appendChild(opt);
  }
}

function speakText(text){
  if(!('speechSynthesis' in window)) return;
  const ut = new SpeechSynthesisUtterance(text);
  const sel = voiceSelect.value;
  if(sel){
    const v = voices.find(x => x.name === sel);
    if(v) ut.voice = v;
  }
  if(!ut.voice){
    ut.voice = voices.find(v=> /en|english/i.test(v.lang || v.name)) || voices[0] || null;
  }
  ut.lang = ut.voice?.lang || 'en-US';
  ut.onstart = ()=> mouth.classList.add('talking');
  ut.onend = ()=> mouth.classList.remove('talking');
  ut.onerror = ()=> mouth.classList.remove('talking');
  speechSynthesis.speak(ut);
}

/* ---------- Speech Recognition ---------- */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
/* ---------- Custom responses ---------- */
const birthDate = new Date("2008-03-18");
function getAge() {
  const today = new Date();
  let age = today.getFullYear() - birthDate.getFullYear();
  const m = today.getMonth() - birthDate.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
  return age;
}
function get18thBirthday() {
  const eighteenth = new Date(birthDate);
  eighteenth.setFullYear(eighteenth.getFullYear() + 18);
  return eighteenth.toDateString();
}

const BASE_IDENTITY = `Celivox is an AI assistant developed by ${devProfile.fullname} (${devProfile.display}), a ${getAge()}-year-old software developer from ${devProfile.origin}. ${devProfile.fullname} created Celivox to ${devProfile.purpose}. Celivox was brought to existence on 10th September 2025.
Developer bio: ${devProfile.bio}
Developer tools: ${devProfile.tools}`;

function isCreatorQuestion(text){
  const q = text.toLowerCase();
  const keywords = [
    "who created you","who developed you","who made you","who found you",
    "when were you made","when were you developed","what tools were used",
    "how were you made","tell me about your developer","your origin",
    "your biography","who is your creator","who brought you into existence",
    "who built you","your development","what is your origin",
    "who programmed you","who founded you","who is responsible for your creation"
  ];
  return keywords.some(k => q.includes(k));
}

function isNameQuestion(text){
  const q = text.toLowerCase();
  const nameKeys = ["what is your name","who are you","your name","may i know your name","what do i call you"];
  return nameKeys.some(k => q.includes(k));
}

async function handleCustomResponses(transcript){
  if(isNameQuestion(transcript)){
    const nameResp = "My name is Celivox.";
    appendBubble('ai', nameResp, new Date().toISOString());
    saveConversation(transcript, nameResp);
    speakText(nameResp);
    return true;
  }

  if(isCreatorQuestion(transcript)){
    const resp = `I was developed by a Nigerian named ${devProfile.fullname}, commonly known as ${devProfile.display}. I was created on ${devProfile.created}. My development involved ${devProfile.tools}. My purpose is ${devProfile.purpose}. My developer originates from ${devProfile.origin}. ${devProfile.bio}`;
    appendBubble('ai', resp, new Date().toISOString());
    saveConversation(transcript, resp);
    speakText(resp);
    return true;
  }

  if(/when (was|were) (you|it) (developed|created)/i.test(transcript)){
    const resp = `I was created on ${devProfile.created}.`;
    appendBubble('ai', resp, new Date().toISOString());
    saveConversation(transcript, resp);
    speakText(resp);
    return true;
  }

  return false;
}

/* ---------- API calls ---------- */
async function getAIReply(text) {
  // Include last 10 messages for context
  const history = JSON.parse(localStorage.getItem('celivox_memory') || '[]');
  const memoryContext = history.slice(-10).map(item => ({
    role: item.a ? 'ai' : 'user',
    content: item.a || item.q
  }));

  // Add the new user message
  memoryContext.push({ role: 'user', content: text });

  // Custom local responses first
  const lower = text.toLowerCase();
  if (lower.includes("generate image") || lower.includes("draw")) {
    return { type: "text", text: "üñºÔ∏è Image generation will be available in Celivox Premium soon!" };
  }
  if (lower.includes("turn 18") || lower.includes("when will your developer turn 18")) {
    return { type: "text", text: `Emmanuel Nwaije Ikemefuna will turn 18 on ${get18thBirthday()}.` };
  }

  try {
    const provider = "gemini";
    const response = await fetch("/.netlify/functions/api", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text, provider, memory: memoryContext })
    });
    const data = await response.json();
    return { type: "text", text: data.reply || "‚ùå I couldn‚Äôt get a response now." };
  } catch (err) {
    return { type: "text", text: "‚ùå Backend error: " + err.message };
  }
}
/* ---------- API call with memory ---------- */
async function callOpenRouterWithMemory(prompt){
  return await askServer(prompt); // backend already handles memory
}

/* ---------- Start talking with memory ---------- */
async function startTalking() {
  if (!SR) {
    alert("Speech recognition not supported. Use Chrome/Edge.");
    return;
  }

  const recognition = new SR();
  recognition.lang = 'en-US';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  talkBtn.disabled = true;
  talkBtn.innerHTML = '<i class="fa-solid fa-microphone-lines"></i> Listening...';

  recognition.onresult = async (ev) => {
    const transcript = ev.results[0][0].transcript.trim();
    appendBubble('user', transcript, new Date().toISOString());

    const handled = await handleCustomResponses(transcript);
    if (!handled) {
      try {
        // Memory-aware API call
        const { text: reply } = await getAIReply(transcript);
        appendBubble('ai', reply, new Date().toISOString());
        saveConversation(transcript, reply);
        speakText(reply);
      } catch (err) {
        const errMsg = "‚ùå Could not get AI response: " + err.message;
        appendBubble('ai', errMsg, new Date().toISOString());
        console.error(err);
      }
    }

    talkBtn.disabled = false;
    talkBtn.innerHTML = '<i class="fa-solid fa-microphone"></i> You Can Talk';
  };

  recognition.onerror = (e) => {
    console.error('Recognition error', e);
    talkBtn.disabled = false;
    talkBtn.innerHTML = '<i class="fa-solid fa-microphone"></i> You Can Talk';
  };

  recognition.onend = () => {
    talkBtn.disabled = false;
    talkBtn.innerHTML = '<i class="fa-solid fa-microphone"></i> You Can Talk';
  };

  recognition.start();
}

// Attach listener
talkBtn.addEventListener('click', startTalking);

/* ---------- Ensure voices load correctly ---------- */
speechSynthesis.onvoiceschanged = () => { loadVoicesWhenReady(); };
</script>
</body>
</html>